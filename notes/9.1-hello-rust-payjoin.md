# ðŸ‘‹ Payjoin Dev Kit (rust-payjoin)
 https://github.com/payjoin/rust-payjoin

## Background
Read the BIPs
- [BIP 78: A Simple Payjoin Proposal ("payjoin v1")](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki)
- [BIP 77: Payjoin Version 2: Serverless Payjoin](https://github.com/bitcoin/bips/pull/1483).
- [The readable `.mediawiki` version of BIP 77](https://github.com/bitcoin/bips/blob/799e8c145da0304d847abfe59bd2311a1cf78968/bip-0077.mediawiki)

Other reference material
- Dan Gould's initial announcement to mailing list: https://gnusha.org/pi/bitcoindev/3C0A6E4C-444E-4E75-829C-1A21D8EE40E0@ngould.dev/
- ~~Dan Gould's BIP 77 gist (many revisions): https://gist.github.com/DanGould/243e418752fff760c9f6b23bba8a32f9~~ This is older than the current BIP 77 doc
- Dan Gould's follow up mailing list post (more or less replicates the above gist): https://gnusha.org/pi/bitcoindev/7B11AE34-27A7-46ED-95BF-66CA13BA26F3@ngould.dev/
- [Privacy First: Send Payjoin Transactions with Payjoin Dev Kit](https://payjoindevkit.org/tutorials/send-payjoin-with-pdk.html)

Further reading or understanding required (TODO):
- RFC 9180 Hybrid Public Key Encryption protocol - https://www.rfc-editor.org/rfc/rfc9180.html
- RFC 9458 Oblivious HTTP - https://www.ietf.org/rfc/rfc9458.html

### Differences between Payjoin v1 and v2
`v2` replaces the need for receiver to host a secure public endpoint, instead an "an untrusted 3rd party payjoin-directory store-and-forward server" relay is used as a "rendezvous point for sender and receiver to meet".

`v1` is basically synchronous, requiring sender and receiver to be online at the same time. `v2` is inherently asynchronous - sender and receiver payloads are buffered at the relay to support async interaction.

`v1` payloads can possibly be neither end-to-end authenticated nor encrypted between sender and receiver in a setup involving an unsecured payjoin server running separately to the payment server. 
It's possible for a malicious unsecured payjoin server to modify in-flight payjoin PSBT. 
To prevent this, need to disable output substitution - output substitution is useful to the receiver for things like change scriptPubKey output, decrease output involvement amount etc.

`v2` payloads are authenticated and encrypted, the relay can't snoop on message contents or forge messages. The relay is an Oblivious HTTP server.

`v1` is built on TLS and Tor, `v2` is built on Hybrid Public Key Encryption (HPKE).

## Payjoin with rust-payjoin
There's 2 roles in a payjoin: sender and receiver. Accordingly there are 2 main components in the `payjoin` crate: send and receive. Both have `v1` (BIP 78) and `v2` (BIP 77) variants.

Only BIP 77 Payjoin `v2` is enabled by default. `v1` feature needs to be enabled to use `v1` (BIP 78). But `v2` is backwards compatible with `v1`.

In `v2`, the receiver registers with a payjoin directory server using the public key of a keypair generated for a single payjoin session.
This creates a *receiver* subdirectory on the directory server.
The receiver long polls GET requests to this subdirectory to await a payjoin request to a payjoin session from the sender.
The receiver provides the sender with a BIP 21 payjoin URI out-of-band. It will be something like:
```
bitcoin:bcrt1qac83yhcudykksa6juycn6ms2awyjpmt6nxhk2d?amount=0.0001&pjos=0&pj=HTTPS://PAYJO.IN/0U8D280
8MRAKX%23RK1Q0DSJJ9Q62MSQ0RKK8KNUQATYALQP6L9U2YU2KCKJTX8ZXD7SN0C5+OH1QYPM59NK2LXXS4890SUAXXYT25Z2VAPHP0X7YEYCJXGWAG6UG9ZU6NQ+EX1
KUVUJEC
```

The sender creates an HPKE Auth mode payload containing a PSBT (`Original PSBT`). Also sends a sender session public key as associated data.
Sends to directory server, is stored in the *receivers* subdirectory. The sender polls GET requests to the *senders* subdirectory to await a `Proposal PSBT` response (from the receiver, via the *senders* subdirectory).

The receiver, upon coming online/receiving a response to long poll GET in their *receivers* subdirectory, decrypts and authenticates the `Original PSBT`. 
The `Original PSBT` must satisfy the `receiver checklist` outlined in the spec.
The receiver then updates the `Original PSBT` to include new signed inputs and outputs, invalidating sender signatures, and also may adjust the fee, creating the `Proposal PSBT`.
The `Proposal PSBT` is then POSTed to the *senders* subdirectory on the directory server by the receiver.

The sender, who is polling their *senders* subdirectory, receives the `Proposal PSBT`. The `Proposal PSBT` must satisfy the `sender checklist` outlined in the spec.
If satisfied, they sign their inputs and can broadcast the transaction to the network.

### `payjoin-cli` crate
Can use this to setup and execute a payjoin using Bitcoin Core as the wallet. Useful for testing payjoin locally.

### macOS/Nix/Apple Silicon issues
In nix shell (`nix develop`), `cargo build` initially failed:

```bash
cargo build
...
error: linking with `cc` failed: exit status: 1
...
  = note: ld: library not found for -lbz2
          clang: error: linker command failed with exit code 1 (use -v to see invocation)
          

error: could not compile `bitcoind` (build script) due to 1 previous error
```

Solution:
1) `brew install bzip2`.
2) Note the installation logs, `bzip2` is keg-only:
```
bzip2 is keg-only, which means it was not symlinked into /opt/homebrew,
because macOS already provides this software and installing another version in
parallel can cause all kinds of trouble.

If you need to have bzip2 first in your PATH, run:
  echo 'export PATH="/opt/homebrew/opt/bzip2/bin:$PATH"' >> ~/.zshrc

For compilers to find bzip2 you may need to set:
  export LDFLAGS="-L/opt/homebrew/opt/bzip2/lib"
  export CPPFLAGS="-I/opt/homebrew/opt/bzip2/include"
```
3) Create a Nix shell overlay (`shell-overlay.nix`) referencing these paths:
```
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = [ pkgs.pkg-config ];
  shellHook = ''
    export LIBRARY_PATH="$LIBRARY_PATH:/opt/homebrew/opt/bzip2/lib"
    export C_INCLUDE_PATH="$C_INCLUDE_PATH:/opt/homebrew/opt/bzip2/include"
    export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/opt/homebrew/opt/bzip2/lib/pkgconfig"
  '';
}
```
4) Run `nix-shell` again:
```bash
nix-shell shell-overlay.nix --command "nix develop"
```
5) Build is now successful!

### Running the tests
Run the tests from the root directory (`contrib/test.sh`) and encounter some test failures:

```
---- integration::v2::v1_to_v2 stdout ----
thread 'integration::v2::v1_to_v2' panicked at /Users/<user>/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/testcontainers-0.15.0/src/clients/cli.rs:51:13:
Failed to start container, check log for details

---- integration::v2::test_bad_ohttp_keys stdout ----
thread 'integration::v2::test_bad_ohttp_keys' panicked at /Users/<user>/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/testcontainers-0.15.0/src/clients/cli.rs:51:13:
Failed to start container, check log for details

---- integration::v2::test_session_expiration stdout ----
thread 'integration::v2::test_session_expiration' panicked at /Users/<user>/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/testcontainers-0.15.0/src/clients/cli.rs:51:13:
Failed to start container, check log for details
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- integration::multiparty::ns1r stdout ----
thread 'integration::multiparty::ns1r' panicked at /Users/<user>/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/testcontainers-0.15.0/src/clients/cli.rs:51:13:
Failed to start container, check log for details

---- integration::v2::v2_to_v2 stdout ----
thread 'integration::v2::v2_to_v2' panicked at /Users/<user>/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/testcontainers-0.15.0/src/clients/cli.rs:51:13:
Failed to start container, check log for details
```

Clearly relates to spinning up Docker containers for some of the tests...Docker Desktop was running but the daemon was not running/properly initialised! Once daemon was running, things looking better, albeit still with a test failure:

```
failures:

---- e2e::send_receive_payjoin_v2 stdout ----
Database running on 127.0.0.1:55005
Directory server binding to port [::]:55648
Directory server binding to port [::]:55649
thread 'e2e::send_receive_payjoin_v2' panicked at payjoin-cli/tests/e2e.rs:277:14:
payjoin-cli receiver should output a bitcoin URI
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    e2e::send_receive_payjoin_v2

test result: FAILED. 1 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 11.26s

error: test failed, to rerun pass `-p payjoin-cli --test e2e`
```

### Experiment with payjoin-cli
To experiment with the `payjoin-cli` one method is to use a local bitcoind running in regtest mode. The [Manual End to End Regtest Testing](https://github.com/payjoin/rust-payjoin/tree/master/payjoin-cli#manual-end-to-end-regtest-testing) instructions state:
> Set up 2 local regtest wallets and fund them. This example uses "boom" and "ocean"

```bash
# Spin up bitcoind in regtest mode
# I like using -printtoconsole to see the log
bitcoind -regtest -printtoconsole
# Create 2 regtest wallets
bitcoin-cli -regtest createwallet "boom"
bitcoin-cli -regtest createwallet "ocean"
# Get addresses for the wallets
boom_address=$(bitcoin-cli -regtest -rpcwallet=boom getnewaddress); echo $boom_address
ocean_address=$(bitcoin-cli -regtest -rpcwallet=ocean getnewaddress); echo $ocean_address
# Generate blocks to fund wallets
# 101 blocks so that coinbase TXs are mature/spendable
bitcoin-cli -regtest generatetoaddress 101 $boom_address
bitcoin-cli -regtest generatetoaddress 101 $ocean_address
# Check wallet balances
bitcoin-cli -regtest -rpcwallet=boom getbalance
bitcoin-cli -regtest -rpcwallet=ocean getbalance
```

Now setup to receive. 
> From the directory you'll run payjoin-cli, assuming "boom" is the name of the receiving wallet, 18443 is the rpc port, and you wish to request 10,000 sats run:
>
>```console
>RUST_LOG=debug cargo run --features=_danger-local-https -- -r "http://localhost:18443/wallet/boom" receive 10000
>```

Running from the `target/debug`, specifying the binary (`--bin=payjoin-cli`):
```
Error: V2 configuration is required for BIP77 mode
```

I knew this wouldn't work, having not specified a configuration, but I wanted to see how far it would get.

Aside from configuration, it's not clear to me how to run the relay locally - the docs reference external OHTTP and payjoin directory server:

>```toml
># config.toml
>...
># a production payjoin directory server
>pj_directory="https://payjo.in"
># payjo.in's ohttp_keys can now be fetched rather than configured ahead of time
> # an ohttp relay with ingress to payjo.in
>ohttp_relay="https://pj.bobspacebkk.com"
>```

Ideally I'd like to run the full stack locally but let's first try hitting these external services first. This is the `config.toml`:
```toml
# config.toml for PayJoin V2
# Bitcoin RPC configuration for RECEIVER
bitcoind_rpchost = "http://localhost:18443/wallet/boom"

# V2 Payjoin configuration
[v2]
pj_directory = "https://payjo.in"
ohttp_relay = "https://pj.bobspacebkk.com" 
```

After battling some issues with RPC auth (wouldn't auth with "correct" credentials), I managed to get something meaningful running on the receiver side of things with:
```bash
RUST_LOG=debug cargo run --bin=payjoin-cli --features=v2,_danger-local-https -- --cookie-file="/Users/<user>/Library/Application Support/Bitcoin/regtest/.cookie" --rpchost="http://localhost:18443/wallet/boom" receive 10000
```
Output:
```
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iterator] ordering before clearing tears: {0: 0}, max_header_stable_lsn: 0
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iterator] in clean_tail_tears, found missing item in tail: None and we'll scan segments {0: 0} above lowest lsn 0
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iterator] filtering out segments after detected tear at (lsn, lid) 95
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iterator] hit max_lsn 95 in iterator, stopping
[2025-03-05T03:42:45Z DEBUG sled::pagecache::snapshot] zeroing the end of the recovered segment at lsn 0 between lids 96 and 524287
[2025-03-05T03:42:45Z DEBUG sled::pagecache::blob_io] gc_blobs removing any blob with an lsn above 96
[2025-03-05T03:42:45Z DEBUG sled::pagecache::segment] SA starting with tip 524288 stable -1 free {}
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iobuf] starting log at recovered active offset 96, recovered lsn 96
[2025-03-05T03:42:45Z DEBUG sled::pagecache::iobuf] starting IoBufs with next_lsn: 96 next_lid: 96
[2025-03-05T03:42:45Z DEBUG sled::pagecache] load_snapshot loading pages from 0..4
[2025-03-05T03:42:45Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T03:42:45Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T03:42:45Z DEBUG bitcoincore_rpc] JSON-RPC request: getnewaddress [null,null]
[2025-03-05T03:42:45Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T03:42:45Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
Bootstrapping private network transport over Oblivious HTTP
[2025-03-05T03:42:45Z DEBUG reqwest::connect] starting new connection: https://payjo.in/
[2025-03-05T03:42:45Z DEBUG reqwest::connect] proxy(https://pj.bobspacebkk.com) intercepts 'https://payjo.in/'
[2025-03-05T03:42:46Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T03:42:46Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T03:42:46Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T03:42:46Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T03:42:46Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T03:42:46Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T03:42:46Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
[2025-03-05T03:42:47Z DEBUG rustls::client::hs] No cached session for DnsName("payjo.in")
[2025-03-05T03:42:47Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T03:42:47Z DEBUG rustls::client::hs] Using ciphersuite TLS13_AES_256_GCM_SHA384
[2025-03-05T03:42:47Z DEBUG rustls::client::tls13] Not resuming
[2025-03-05T03:42:47Z DEBUG rustls::client::tls13] TLS1.3 encrypted extensions: [ServerNameAck, Protocols([ProtocolName(687474702f312e31)])]
[2025-03-05T03:42:47Z DEBUG rustls::client::hs] ALPN protocol is Some(b"http/1.1")
[2025-03-05T03:42:47Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T03:42:47Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T03:42:47Z DEBUG sled::meta] allocated pid 5 for root of new_tree [114, 101, 99, 118, 95, 115, 101, 115, 115, 105, 111, 110, 115]
[2025-03-05T03:42:47Z DEBUG sled::pagecache::iobuf] advancing offset within the current segment from 96 to 1018
[2025-03-05T03:42:47Z DEBUG sled::pagecache::iobuf] wrote lsns 96-1017 to disk at offsets 96-1017, maxed false complete_len 922
[2025-03-05T03:42:47Z DEBUG sled::pagecache::iobuf] mark_interval(96, 922)
[2025-03-05T03:42:47Z DEBUG sled::pagecache::iobuf] new highest interval: 96 - 1017
[2025-03-05T03:42:47Z DEBUG sled::pagecache::iobuf] make_stable(1017) returning
Receive session established
Request Payjoin by sharing this Payjoin Uri:
bitcoin:bcrt1qac83yhcudykksa6juycn6ms2awyjpmt6nxhk2d?amount=0.0001&pjos=0&pj=HTTPS://PAYJO.IN/0U8D2808MRAKX%23RK1Q0DSJJ9Q62MSQ0RKK8KNUQATYALQP6L9U2YU2KCKJTX8ZXD7SN0C5+OH1QYPM59NK2LXXS4890SUAXXYT25Z2VAPHP0X7YEYCJXGWAG6UG9ZU6NQ+EX1KUVUJEC
Polling receive request...
[2025-03-05T03:42:47Z DEBUG reqwest::connect] starting new connection: https://pj.bobspacebkk.com/
[2025-03-05T03:42:48Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T03:42:48Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T03:42:48Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T03:42:48Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T03:42:48Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T03:42:48Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T03:42:48Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
[2025-03-05T03:43:19Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T03:43:19Z DEBUG payjoin::receive::v2] response is empty
[2025-03-05T03:43:19Z DEBUG payjoin_cli::app::v2] got response
Polling receive request...
```

Running the sender side of things, we need a `config.toml` that is almost the same as the receiver's, except we need to specify sender's wallet:
```toml
# config.toml for PayJoin V2
# Bitcoin RPC configuration for SENDER
bitcoind_rpchost = "http://localhost:18443/wallet/ocean"

# V2 Payjoin configuration
[v2]
pj_directory = "https://payjo.in"
ohttp_relay = "https://pj.bobspacebkk.com" 
```

I ended up running the sender side with the `release` binary (receiver side was running `debug`) to simply allow 2 different `config.toml` and binaries to run side-by-side.

```bash
RUST_LOG=debug cargo run --bin=payjoin-cli --release --features=v2,_danger-local-https -- --cookie-file="/Users/<user>/Library/Application Support/Bitcoin/regtest/.cookie" --rpchost="http://localhost:18443/wallet/ocean" send "bitcoin:bcrt1qac83yhcudykksa6juycn6ms2awyjpmt6nxhk2d?amount=0.0001&pjos=0&pj=HTTPS://PAYJO.IN/0U8D2808MRAKX%23RK1Q0DSJJ9Q62MSQ0RKK8KNUQATYALQP6L9U2YU2KCKJTX8ZXD7SN0C5+OH1QYPM59NK2LXXS4890SUAXXYT25Z2VAPHP0X7YEYCJXGWAG6UG9ZU6NQ+EX1KUVUJEC" --fee-rate=1
```

But hit an error:
```
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iterator] ordering before clearing tears: {0: 0}, max_header_stable_lsn: 0
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iterator] in clean_tail_tears, found missing item in tail: None and we'll scan segments {0: 0} above lowest lsn 0
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iterator] filtering out segments after detected tear at (lsn, lid) 2703
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iterator] hit max_lsn 2703 in iterator, stopping
[2025-03-05T04:15:38Z DEBUG sled::pagecache::snapshot] zeroing the end of the recovered segment at lsn 0 between lids 2704 and 524287
[2025-03-05T04:15:38Z DEBUG sled::pagecache::blob_io] gc_blobs removing any blob with an lsn above 2704
[2025-03-05T04:15:38Z DEBUG sled::pagecache::segment] SA starting with tip 524288 stable -1 free {}
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iobuf] starting log at recovered active offset 2704, recovered lsn 2704
[2025-03-05T04:15:38Z DEBUG sled::pagecache::iobuf] starting IoBufs with next_lsn: 2704 next_lid: 2704
[2025-03-05T04:15:38Z DEBUG sled::pagecache] load_snapshot loading pages from 0..6
[2025-03-05T04:15:38Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T04:15:38Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T04:15:38Z DEBUG payjoin::send::v2] ohttp_relay_url: Url { scheme: "https", cannot_be_a_base: false, username: "", password: None, host: Some(Domain("pj.bobspacebkk.com")), port: None, path: "/", query: None, fragment: None }
Posting Original PSBT Payload request...
[2025-03-05T04:15:38Z DEBUG sled::pagecache::logger] IoBufs dropped
Error: No such file or directory (os error 2)
```

This stumped me for a while, what file or directory was possibly being accessed in making a request `Posting Original PSBT Payload request...`?

Turns out it was the self-signed certificate and the `_danger-local-https` feature. Because I'm not connecting to a local server, I can disable this feature:
```bash
RUST_LOG=debug cargo run --bin=payjoin-cli --release --fea
tures=v2 -- --cookie-file="/Users/<user>/Library/Application Support/Bitcoin/regtest/.cookie" --rpchost="http://localhost
:18443/wallet/ocean" send "bitcoin:bcrt1qac83yhcudykksa6juycn6ms2awyjpmt6nxhk2d?amount=0.0001&pjos=0&pj=HTTPS://PAYJO.IN/0U8D280
8MRAKX%23RK1Q0DSJJ9Q62MSQ0RKK8KNUQATYALQP6L9U2YU2KCKJTX8ZXD7SN0C5+OH1QYPM59NK2LXXS4890SUAXXYT25Z2VAPHP0X7YEYCJXGWAG6UG9ZU6NQ+EX1
KUVUJEC" --fee-rate=1
```

Running the above yields the following full output:
```
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iterator] ordering before clearing tears: {0: 0}, max_header_stable_lsn: 0
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iterator] in clean_tail_tears, found missing item in tail: None and we'll scan segments {0: 0} above lowest lsn 0
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iterator] filtering out segments after detected tear at (lsn, lid) 2703
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iterator] hit max_lsn 2703 in iterator, stopping
[2025-03-05T04:21:13Z DEBUG sled::pagecache::snapshot] zeroing the end of the recovered segment at lsn 0 between lids 2704 and 524287
[2025-03-05T04:21:13Z DEBUG sled::pagecache::blob_io] gc_blobs removing any blob with an lsn above 2704
[2025-03-05T04:21:13Z DEBUG sled::pagecache::segment] SA starting with tip 524288 stable -1 free {}
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iobuf] starting log at recovered active offset 2704, recovered lsn 2704
[2025-03-05T04:21:13Z DEBUG sled::pagecache::iobuf] starting IoBufs with next_lsn: 2704 next_lid: 2704
[2025-03-05T04:21:13Z DEBUG sled::pagecache] load_snapshot loading pages from 0..6
[2025-03-05T04:21:13Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T04:21:13Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T04:21:13Z DEBUG payjoin::send::v2] ohttp_relay_url: Url { scheme: "https", cannot_be_a_base: false, username: "", password: None, host: Some(Domain("pj.bobspacebkk.com")), port: None, path: "/", query: None, fragment: None }
Posting Original PSBT Payload request...
[2025-03-05T04:21:13Z DEBUG reqwest::connect] starting new connection: https://pj.bobspacebkk.com/
[2025-03-05T04:21:13Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:13Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T04:21:13Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T04:21:13Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T04:21:13Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T04:21:13Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T04:21:13Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
Sent fallback transaction
[2025-03-05T04:21:14Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T04:21:14Z DEBUG reqwest::connect] starting new connection: https://pj.bobspacebkk.com/
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:16Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T04:21:16Z DEBUG payjoin_cli::app] Proposed psbt: Psbt {
        unsigned_tx: Transaction {
            version: Version(
                2,
            ),
            lock_time: 0 blocks,
            input: [
                TxIn {
                    previous_output: OutPoint {
                        txid: 6f75a05422132508204670aa61633fafac9282dc1978a836b61ee43cb9309898,
                        vout: 0,
                    },
                    script_sig: Script(),
                    sequence: Sequence(0xfffffffd),
                    witness: Witness: {
                        indices: 0,
                        indices_start: 0,
                        witnesses: [
                        ],
                    }
                    ,
                },
                TxIn {
                    previous_output: OutPoint {
                        txid: 721ea4ff4a18490389f7ab037989e8a4f966b387ce4ff67e6ec72a2ca56837ff,
                        vout: 0,
                    },
                    script_sig: Script(),
                    sequence: Sequence(0xfffffffd),
                    witness: Witness: {
                        indices: 0,
                        indices_start: 0,
                        witnesses: [
                        ],
                    }
                    ,
                },
            ],
            output: [
                TxOut {
                    value: 4999989791 SAT,
                    script_pubkey: Script(OP_0 OP_PUSHBYTES_20 93d3110dff232f4622981f6b80e7936eaae5a54e),
                },
                TxOut {
                    value: 5000010000 SAT,
                    script_pubkey: Script(OP_0 OP_PUSHBYTES_20 ee0f125f1c692d687752e1313d6e0aeb8920ed7a),
                },
            ],
        },
        version: 0,
        xpub: {},
        proprietary: {},
        unknown: {},
        inputs: [
            Input {
                non_witness_utxo: Some(
                    Transaction {
                        version: Version(
                            2,
                        ),
                        lock_time: 0 blocks,
                        input: [
                            TxIn {
                                previous_output: OutPoint {
                                    txid: 0000000000000000000000000000000000000000000000000000000000000000,
                                    vout: 4294967295,
                                },
                                script_sig: Script(OP_PUSHBYTES_1 66 OP_0),
                                sequence: Sequence(0xffffffff),
                                witness: Witness: {
                                    indices: 0,
                                    indices_start: 0,
                                    witnesses: [
                                    ],
                                }
                                ,
                            },
                        ],
                        output: [
                            TxOut {
                                value: 5000000000 SAT,
                                script_pubkey: Script(OP_0 OP_PUSHBYTES_20 cea41ecd00882c0784d9546ab3ad2f57946fe284),
                            },
                            TxOut {
                                value: 0 SAT,
                                script_pubkey: Script(OP_RETURN OP_PUSHBYTES_36 aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9),
                            },
                        ],
                    },
                ),
                witness_utxo: Some(
                    TxOut {
                        value: 5000000000 SAT,
                        script_pubkey: Script(OP_0 OP_PUSHBYTES_20 cea41ecd00882c0784d9546ab3ad2f57946fe284),
                    },
                ),
                partial_sigs: {},
                sighash_type: None,
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                final_script_sig: None,
                final_script_witness: None,
                ripemd160_preimages: {},
                sha256_preimages: {},
                hash160_preimages: {},
                hash256_preimages: {},
                tap_key_sig: None,
                tap_script_sigs: {},
                tap_scripts: {},
                tap_key_origins: {},
                tap_internal_key: None,
                tap_merkle_root: None,
                proprietary: {},
                unknown: {},
            },
            Input {
                non_witness_utxo: Some(
                    Transaction {
                        version: Version(
                            2,
                        ),
                        lock_time: 0 blocks,
                        input: [
                            TxIn {
                                previous_output: OutPoint {
                                    txid: 0000000000000000000000000000000000000000000000000000000000000000,
                                    vout: 4294967295,
                                },
                                script_sig: Script(OP_PUSHBYTES_1 60 OP_0),
                                sequence: Sequence(0xffffffff),
                                witness: Witness: {
                                    indices: 0,
                                    indices_start: 0,
                                    witnesses: [
                                    ],
                                }
                                ,
                            },
                        ],
                        output: [
                            TxOut {
                                value: 5000000000 SAT,
                                script_pubkey: Script(OP_0 OP_PUSHBYTES_20 3d94d294dce4b8bdd100f0116740c3be17209c18),
                            },
                            TxOut {
                                value: 0 SAT,
                                script_pubkey: Script(OP_RETURN OP_PUSHBYTES_36 aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9),
                            },
                        ],
                    },
                ),
                witness_utxo: Some(
                    TxOut {
                        value: 5000000000 SAT,
                        script_pubkey: Script(OP_0 OP_PUSHBYTES_20 3d94d294dce4b8bdd100f0116740c3be17209c18),
                    },
                ),
                partial_sigs: {},
                sighash_type: None,
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                final_script_sig: None,
                final_script_witness: Some(
                    Witness: {
                        indices: 2,
                        indices_start: 106,
                        witnesses: [
                            [0x30, 0x44, 0x02, 0x20, 0x50, 0xdf, 0xd4, 0x92, 0x19, 0x97, 0x33, 0x19, 0xf0, 0xd9, 0x74, 0xd7, 0x31, 0xf2, 0x11, 0x67, 0xaa, 0x4a, 0xca, 0x9d, 0xbd, 0xf3, 0xff, 0x3d, 0xc7, 0x96, 0x31, 0x4e, 0xec, 0x0b, 0xd3, 0x6b, 0x02, 0x20, 0x5e, 0x3d, 0xa3, 0xbe, 0x7e, 0x8d, 0xef, 0xb2, 0xc4, 0x57, 0xbe, 0x27, 0x06, 0xbc, 0x95, 0x39, 0x2c, 0x8d, 0x56, 0x3a, 0xf8, 0xe5, 0xbb, 0x64, 0x8e, 0xa5, 0x57, 0x5d, 0x51, 0x9e, 0xd6, 0xfd, 0x01],
                            [0x03, 0xed, 0x51, 0x87, 0x10, 0xe3, 0xae, 0x87, 0xd5, 0x6f, 0x72, 0xf8, 0x62, 0x9d, 0xa5, 0x07, 0x7e, 0xc1, 0x1d, 0x7c, 0x8f, 0xe9, 0x84, 0x9a, 0xed, 0x85, 0xdb, 0x1d, 0x12, 0x55, 0xe2, 0x9d, 0xa8],
                        ],
                    }
                    ,
                ),
                ripemd160_preimages: {},
                sha256_preimages: {},
                hash160_preimages: {},
                hash256_preimages: {},
                tap_key_sig: None,
                tap_script_sigs: {},
                tap_scripts: {},
                tap_key_origins: {},
                tap_internal_key: None,
                tap_merkle_root: None,
                proprietary: {},
                unknown: {},
            },
        ],
        outputs: [
            Output {
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                tap_internal_key: None,
                tap_tree: None,
                tap_key_origins: {},
                proprietary: {},
                unknown: {},
            },
            Output {
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                tap_internal_key: None,
                tap_tree: None,
                tap_key_origins: {},
                proprietary: {},
                unknown: {},
            },
        ],
    }
[2025-03-05T04:21:16Z DEBUG bitcoincore_rpc] JSON-RPC request: walletprocesspsbt ["cHNidP8BAJoCAAAAApiYMLk85B62Nqh4GdyCkqyvP2NhqnBGIAglEyJUoHVvAAAAAAD9/////zdopSwqx25+9k/Oh7Nm+aToiXkDq/eJA0kYSv+kHnIAAAAAAP3///8CH8oFKgEAAAAWABST0xEN/yMvRiKYH2uA55NuquWlThAZBioBAAAAFgAU7g8SXxxpLWh3UuExPW4K64kg7XoAAAAAAAEAhAIAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AwFmAP////8CAPIFKgEAAAAWABTOpB7NAIgsB4TZVGqzrS9XlG/ihAAAAAAAAAAAJmokqiGp7eL2HD9x0d79P6mZ36NpU3VcaQaJeZlitIvr2DaXToz5AAAAAAEBHwDyBSoBAAAAFgAUzqQezQCILAeE2VRqs60vV5Rv4oQAAQCEAgAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////8DAWAA/////wIA8gUqAQAAABYAFD2U0pTc5Li90QDwEWdAw74XIJwYAAAAAAAAAAAmaiSqIant4vYcP3HR3v0/qZnfo2lTdVxpBol5mWK0i+vYNpdOjPkAAAAAAQEfAPIFKgEAAAAWABQ9lNKU3OS4vdEA8BFnQMO+FyCcGAEIawJHMEQCIFDf1JIZlzMZ8Nl01zHyEWeqSsqdvfP/PceWMU7sC9NrAiBePaO+fo3vssRXvicGvJU5LI1WOvjlu2SOpVddUZ7W/QEhA+1RhxDjrofVb3L4Yp2lB37BHXyP6YSa7YXbHRJV4p2oAAAA",true,"ALL",false]
[2025-03-05T04:21:16Z DEBUG bitcoincore_rpc] JSON-RPC request: finalizepsbt ["cHNidP8BAJoCAAAAApiYMLk85B62Nqh4GdyCkqyvP2NhqnBGIAglEyJUoHVvAAAAAAD9/////zdopSwqx25+9k/Oh7Nm+aToiXkDq/eJA0kYSv+kHnIAAAAAAP3///8CH8oFKgEAAAAWABST0xEN/yMvRiKYH2uA55NuquWlThAZBioBAAAAFgAU7g8SXxxpLWh3UuExPW4K64kg7XoAAAAAAAEAhAIAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AwFmAP////8CAPIFKgEAAAAWABTOpB7NAIgsB4TZVGqzrS9XlG/ihAAAAAAAAAAAJmokqiGp7eL2HD9x0d79P6mZ36NpU3VcaQaJeZlitIvr2DaXToz5AAAAAAEBHwDyBSoBAAAAFgAUzqQezQCILAeE2VRqs60vV5Rv4oQBCGsCRzBEAiB7oRtEzLwADY5pRmNItrYltZodLp0rfQcB5EYyouM7qwIgMccSE1RLmqG6/nvnomDrU2NfXqZfi+quTiC4DjSld0cBIQIClN1OF/9s1c4yxjHDDU6l+2a0WV83ZkUPiHQY1z7XNgABAIQCAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////wMBYAD/////AgDyBSoBAAAAFgAUPZTSlNzkuL3RAPARZ0DDvhcgnBgAAAAAAAAAACZqJKohqe3i9hw/cdHe/T+pmd+jaVN1XGkGiXmZYrSL69g2l06M+QAAAAABAR8A8gUqAQAAABYAFD2U0pTc5Li90QDwEWdAw74XIJwYAQhrAkcwRAIgUN/UkhmXMxnw2XTXMfIRZ6pKyp298/89x5YxTuwL02sCIF49o75+je+yxFe+Jwa8lTksjVY6+OW7ZI6lV11Rntb9ASED7VGHEOOuh9VvcvhinaUHfsEdfI/phJrthdsdElXinagAAAA=",true]
[2025-03-05T04:21:16Z DEBUG bitcoincore_rpc] JSON-RPC request: sendrawtransaction ["02000000000102989830b93ce41eb636a87819dc8292acaf3f6361aa7046200825132254a0756f0000000000fdffffffff3768a52c2ac76e7ef64fce87b366f9a4e8897903abf7890349184affa41e720000000000fdffffff021fca052a0100000016001493d3110dff232f4622981f6b80e7936eaae5a54e1019062a01000000160014ee0f125f1c692d687752e1313d6e0aeb8920ed7a0247304402207ba11b44ccbc000d8e69466348b6b625b59a1d2e9d2b7d0701e44632a2e33bab022031c71213544b9aa1bafe7be7a260eb53635f5ea65f8beaae4e20b80e34a577470121020294dd4e17ff6cd5ce32c631c30d4ea5fb66b4595f3766450f887418d73ed73602473044022050dfd49219973319f0d974d731f21167aa4aca9dbdf3ff3dc796314eec0bd36b02205e3da3be7e8defb2c457be2706bc95392c8d563af8e5bb648ea5575d519ed6fd012103ed518710e3ae87d56f72f8629da5077ec11d7c8fe9849aed85db1d1255e29da800000000"]
Payjoin sent. TXID: f4715d46490928f7a458077782c845d8a28989c71cf891fc28d2c9fe492549c6
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] advancing offset within the current segment from 2704 to 2871
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] wrote lsns 2704-2870 to disk at offsets 2704-2870, maxed false complete_len 167
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] mark_interval(2704, 167)
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] new highest interval: 2704 - 2870
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] make_stable(2870) returning
[2025-03-05T04:21:16Z DEBUG sled::pagecache::logger] IoBufs dropped
```

The console log of the receiver side:
```
Polling receive request...
[2025-03-05T04:20:56Z DEBUG reqwest::connect] starting new connection: https://pj.bobspacebkk.com/
[2025-03-05T04:20:56Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T04:20:56Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T04:20:56Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T04:20:56Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T04:20:56Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T04:20:56Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T04:20:56Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:14Z DEBUG rustls::common_state] Sending warning alert CloseNotify
[2025-03-05T04:21:14Z DEBUG payjoin::receive] Received original psbt: Psbt { unsigned_tx: Transaction { version: Version(2), lock_time: 0 blocks, input: [TxIn { previous_output: OutPoint { txid: 6f75a05422132508204670aa61633fafac9282dc1978a836b61ee43cb9309898, vout: 0 }, script_sig: Script(), sequence: Sequence(0xfffffffd), witness: Witness: { indices: 0, indices_start: 0, witnesses: [] } }], output: [TxOut { value: 4999989859 SAT, script_pubkey: Script(OP_0 OP_PUSHBYTES_20 93d3110dff232f4622981f6b80e7936eaae5a54e) }, TxOut { value: 10000 SAT, script_pubkey: Script(OP_0 OP_PUSHBYTES_20 ee0f125f1c692d687752e1313d6e0aeb8920ed7a) }] }, version: 0, xpub: {}, proprietary: {}, unknown: {}, inputs: [Input { non_witness_utxo: Some(Transaction { version: Version(2), lock_time: 0 blocks, input: [TxIn { previous_output: OutPoint { txid: 0000000000000000000000000000000000000000000000000000000000000000, vout: 4294967295 }, script_sig: Script(OP_PUSHBYTES_1 66 OP_0), sequence: Sequence(0xffffffff), witness: Witness: { indices: 0, indices_start: 0, witnesses: [] } }], output: [TxOut { value: 5000000000 SAT, script_pubkey: Script(OP_0 OP_PUSHBYTES_20 cea41ecd00882c0784d9546ab3ad2f57946fe284) }, TxOut { value: 0 SAT, script_pubkey: Script(OP_RETURN OP_PUSHBYTES_36 aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9) }] }), witness_utxo: Some(TxOut { value: 5000000000 SAT, script_pubkey: Script(OP_0 OP_PUSHBYTES_20 cea41ecd00882c0784d9546ab3ad2f57946fe284) }), partial_sigs: {}, sighash_type: None, redeem_script: None, witness_script: None, bip32_derivation: {}, final_script_sig: None, final_script_witness: Some(Witness: { indices: 2, indices_start: 106, witnesses: [[0x30, 0x44, 0x02, 0x20, 0x28, 0xf1, 0xdc, 0x55, 0x4e, 0x94, 0x68, 0x3d, 0x80, 0x85, 0xed, 0xfb, 0xfd, 0x27, 0x3a, 0x55, 0x97, 0x07, 0x5b, 0xa0, 0x32, 0x87, 0xa6, 0x03, 0x76, 0x93, 0xd2, 0x66, 0xd6, 0x90, 0x77, 0x67, 0x02, 0x20, 0x07, 0x90, 0x15, 0x25, 0x4a, 0xc5, 0x7e, 0x61, 0x6b, 0xb6, 0x49, 0x6c, 0x6e, 0x70, 0x01, 0xbe, 0xf1, 0xae, 0x27, 0x8f, 0x27, 0xac, 0x55, 0xd1, 0x2b, 0x9c, 0x40, 0x1d, 0x2f, 0xca, 0x9a, 0xe2, 0x01], [0x02, 0x02, 0x94, 0xdd, 0x4e, 0x17, 0xff, 0x6c, 0xd5, 0xce, 0x32, 0xc6, 0x31, 0xc3, 0x0d, 0x4e, 0xa5, 0xfb, 0x66, 0xb4, 0x59, 0x5f, 0x37, 0x66, 0x45, 0x0f, 0x88, 0x74, 0x18, 0xd7, 0x3e, 0xd7, 0x36]] }), ripemd160_preimages: {}, sha256_preimages: {}, hash160_preimages: {}, hash256_preimages: {}, tap_key_sig: None, tap_script_sigs: {}, tap_scripts: {}, tap_key_origins: {}, tap_internal_key: None, tap_merkle_root: None, proprietary: {}, unknown: {} }], outputs: [Output { redeem_script: None, witness_script: None, bip32_derivation: {}, tap_internal_key: None, tap_tree: None, tap_key_origins: {}, proprietary: {}, unknown: {} }, Output { redeem_script: None, witness_script: None, bip32_derivation: {}, tap_internal_key: None, tap_tree: None, tap_key_origins: {}, proprietary: {}, unknown: {} }] }
[2025-03-05T04:21:14Z DEBUG payjoin::receive::optional_parameters] parsed optional parameters: Params { v: 2, disable_output_substitution: false, additional_fee_contribution: Some((68 SAT, 0)), min_fee_rate: FeeRate(250) }
[2025-03-05T04:21:14Z DEBUG payjoin::receive] Received request with params: Params { v: 2, disable_output_substitution: false, additional_fee_contribution: Some((68 SAT, 0)), min_fee_rate: FeeRate(250) }
[2025-03-05T04:21:14Z DEBUG payjoin_cli::app::v2] got response
Fallback transaction received. Consider broadcasting this to get paid if the Payjoin fails:
02000000000101989830b93ce41eb636a87819dc8292acaf3f6361aa7046200825132254a0756f0000000000fdffffff0263ca052a0100000016001493d3110dff232f4622981f6b80e7936eaae5a54e1027000000000000160014ee0f125f1c692d687752e1313d6e0aeb8920ed7a02473044022028f1dc554e94683d8085edfbfd273a5597075ba03287a6037693d266d69077670220079015254ac57e616bb6496c6e7001bef1ae278f27ac55d12b9c401d2fca9ae20121020294dd4e17ff6cd5ce32c631c30d4ea5fb66b4595f3766450f887418d73ed73600000000
[2025-03-05T04:21:14Z DEBUG bitcoincore_rpc] JSON-RPC request: testmempoolaccept [["02000000000101989830b93ce41eb636a87819dc8292acaf3f6361aa7046200825132254a0756f0000000000fdffffff0263ca052a0100000016001493d3110dff232f4622981f6b80e7936eaae5a54e1027000000000000160014ee0f125f1c692d687752e1313d6e0aeb8920ed7a02473044022028f1dc554e94683d8085edfbfd273a5597075ba03287a6037693d266d69077670220079015254ac57e616bb6496c6e7001bef1ae278f27ac55d12b9c401d2fca9ae20121020294dd4e17ff6cd5ce32c631c30d4ea5fb66b4595f3766450f887418d73ed73600000000"]]
[2025-03-05T04:21:14Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T04:21:14Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T04:21:14Z DEBUG bitcoincore_rpc] JSON-RPC request: getaddressinfo ["bcrt1qe6jpangq3qkq0pxe234t8tf0272xlc5yxgy5ht"]
[2025-03-05T04:21:14Z DEBUG sled::pagecache::iobuf] advancing offset within the current segment from 1018 to 1065
[2025-03-05T04:21:15Z DEBUG sled::pagecache::iobuf] wrote lsns 1018-1064 to disk at offsets 1018-1064, maxed false complete_len 47
[2025-03-05T04:21:15Z DEBUG sled::pagecache::iobuf] mark_interval(1018, 47)
[2025-03-05T04:21:15Z DEBUG sled::pagecache::iobuf] new highest interval: 1018 - 1064
[2025-03-05T04:21:15Z DEBUG sled::pagecache::iobuf] make_stable(1064) returning
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getaddressinfo ["bcrt1qj0f3zr0lyvh5vg5cra4cpeund64wtf2wsxpfh7"]
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getblockchaininfo []
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getnetworkinfo []
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: getaddressinfo ["bcrt1qac83yhcudykksa6juycn6ms2awyjpmt6nxhk2d"]
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: listunspent []
[2025-03-05T04:21:15Z DEBUG payjoin::receive::v1] min_fee_rate: FeeRate(250)
[2025-03-05T04:21:15Z DEBUG bitcoincore_rpc] JSON-RPC request: walletprocesspsbt ["cHNidP8BAJoCAAAAApiYMLk85B62Nqh4GdyCkqyvP2NhqnBGIAglEyJUoHVvAAAAAAD9/////zdopSwqx25+9k/Oh7Nm+aToiXkDq/eJA0kYSv+kHnIAAAAAAP3///8CH8oFKgEAAAAWABST0xEN/yMvRiKYH2uA55NuquWlThAZBioBAAAAFgAU7g8SXxxpLWh3UuExPW4K64kg7XoAAAAAAAEAhAIAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AwFmAP////8CAPIFKgEAAAAWABTOpB7NAIgsB4TZVGqzrS9XlG/ihAAAAAAAAAAAJmokqiGp7eL2HD9x0d79P6mZ36NpU3VcaQaJeZlitIvr2DaXToz5AAAAAAEBHwDyBSoBAAAAFgAUzqQezQCILAeE2VRqs60vV5Rv4oQAAQEfAPIFKgEAAAAWABQ9lNKU3OS4vdEA8BFnQMO+FyCcGAAAAA==",true,"ALL",false]
[2025-03-05T04:21:15Z DEBUG payjoin_cli::app::v2] Receiver's Payjoin proposal PSBT Rsponse: Psbt {
        unsigned_tx: Transaction {
            version: Version(
                2,
            ),
            lock_time: 0 blocks,
            input: [
                TxIn {
                    previous_output: OutPoint {
                        txid: 6f75a05422132508204670aa61633fafac9282dc1978a836b61ee43cb9309898,
                        vout: 0,
                    },
                    script_sig: Script(),
                    sequence: Sequence(0xfffffffd),
                    witness: Witness: {
                        indices: 0,
                        indices_start: 0,
                        witnesses: [
                        ],
                    }
                    ,
                },
                TxIn {
                    previous_output: OutPoint {
                        txid: 721ea4ff4a18490389f7ab037989e8a4f966b387ce4ff67e6ec72a2ca56837ff,
                        vout: 0,
                    },
                    script_sig: Script(),
                    sequence: Sequence(0xfffffffd),
                    witness: Witness: {
                        indices: 0,
                        indices_start: 0,
                        witnesses: [
                        ],
                    }
                    ,
                },
            ],
            output: [
                TxOut {
                    value: 4999989791 SAT,
                    script_pubkey: Script(OP_0 OP_PUSHBYTES_20 93d3110dff232f4622981f6b80e7936eaae5a54e),
                },
                TxOut {
                    value: 5000010000 SAT,
                    script_pubkey: Script(OP_0 OP_PUSHBYTES_20 ee0f125f1c692d687752e1313d6e0aeb8920ed7a),
                },
            ],
        },
        version: 0,
        xpub: {},
        proprietary: {},
        unknown: {},
        inputs: [
            Input {
                non_witness_utxo: None,
                witness_utxo: None,
                partial_sigs: {},
                sighash_type: None,
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                final_script_sig: None,
                final_script_witness: None,
                ripemd160_preimages: {},
                sha256_preimages: {},
                hash160_preimages: {},
                hash256_preimages: {},
                tap_key_sig: None,
                tap_script_sigs: {},
                tap_scripts: {},
                tap_key_origins: {},
                tap_internal_key: None,
                tap_merkle_root: None,
                proprietary: {},
                unknown: {},
            },
            Input {
                non_witness_utxo: Some(
                    Transaction {
                        version: Version(
                            2,
                        ),
                        lock_time: 0 blocks,
                        input: [
                            TxIn {
                                previous_output: OutPoint {
                                    txid: 0000000000000000000000000000000000000000000000000000000000000000,
                                    vout: 4294967295,
                                },
                                script_sig: Script(OP_PUSHBYTES_1 60 OP_0),
                                sequence: Sequence(0xffffffff),
                                witness: Witness: {
                                    indices: 0,
                                    indices_start: 0,
                                    witnesses: [
                                    ],
                                }
                                ,
                            },
                        ],
                        output: [
                            TxOut {
                                value: 5000000000 SAT,
                                script_pubkey: Script(OP_0 OP_PUSHBYTES_20 3d94d294dce4b8bdd100f0116740c3be17209c18),
                            },
                            TxOut {
                                value: 0 SAT,
                                script_pubkey: Script(OP_RETURN OP_PUSHBYTES_36 aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9),
                            },
                        ],
                    },
                ),
                witness_utxo: Some(
                    TxOut {
                        value: 5000000000 SAT,
                        script_pubkey: Script(OP_0 OP_PUSHBYTES_20 3d94d294dce4b8bdd100f0116740c3be17209c18),
                    },
                ),
                partial_sigs: {},
                sighash_type: None,
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                final_script_sig: None,
                final_script_witness: Some(
                    Witness: {
                        indices: 2,
                        indices_start: 106,
                        witnesses: [
                            [0x30, 0x44, 0x02, 0x20, 0x50, 0xdf, 0xd4, 0x92, 0x19, 0x97, 0x33, 0x19, 0xf0, 0xd9, 0x74, 0xd7, 0x31, 0xf2, 0x11, 0x67, 0xaa, 0x4a, 0xca, 0x9d, 0xbd, 0xf3, 0xff, 0x3d, 0xc7, 0x96, 0x31, 0x4e, 0xec, 0x0b, 0xd3, 0x6b, 0x02, 0x20, 0x5e, 0x3d, 0xa3, 0xbe, 0x7e, 0x8d, 0xef, 0xb2, 0xc4, 0x57, 0xbe, 0x27, 0x06, 0xbc, 0x95, 0x39, 0x2c, 0x8d, 0x56, 0x3a, 0xf8, 0xe5, 0xbb, 0x64, 0x8e, 0xa5, 0x57, 0x5d, 0x51, 0x9e, 0xd6, 0xfd, 0x01],
                            [0x03, 0xed, 0x51, 0x87, 0x10, 0xe3, 0xae, 0x87, 0xd5, 0x6f, 0x72, 0xf8, 0x62, 0x9d, 0xa5, 0x07, 0x7e, 0xc1, 0x1d, 0x7c, 0x8f, 0xe9, 0x84, 0x9a, 0xed, 0x85, 0xdb, 0x1d, 0x12, 0x55, 0xe2, 0x9d, 0xa8],
                        ],
                    }
                    ,
                ),
                ripemd160_preimages: {},
                sha256_preimages: {},
                hash160_preimages: {},
                hash256_preimages: {},
                tap_key_sig: None,
                tap_script_sigs: {},
                tap_scripts: {},
                tap_key_origins: {},
                tap_internal_key: None,
                tap_merkle_root: None,
                proprietary: {},
                unknown: {},
            },
        ],
        outputs: [
            Output {
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                tap_internal_key: None,
                tap_tree: None,
                tap_key_origins: {},
                proprietary: {},
                unknown: {},
            },
            Output {
                redeem_script: None,
                witness_script: None,
                bip32_derivation: {},
                tap_internal_key: None,
                tap_tree: None,
                tap_key_origins: {},
                proprietary: {},
                unknown: {},
            },
        ],
    }
[2025-03-05T04:21:15Z DEBUG payjoin::receive::v2] Payjoin PSBT target: https://payjo.in/UD67ZDDDAWS92
Got a request from the sender. Responding with a Payjoin proposal.
[2025-03-05T04:21:15Z DEBUG reqwest::connect] starting new connection: https://pj.bobspacebkk.com/
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] No cached session for DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] Not resuming any session
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] ALPN protocol is None
[2025-03-05T04:21:15Z DEBUG rustls::client::hs] Using ciphersuite TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12::server_hello] Server supports tickets
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12] ECDHE curve is EcParameters { curve_type: NamedCurve, named_group: X25519 }
[2025-03-05T04:21:15Z DEBUG rustls::client::tls12] Server DNS name is DnsName("pj.bobspacebkk.com")
[2025-03-05T04:21:16Z DEBUG rustls::common_state] Sending warning alert CloseNotify
Response successful. Watch mempool for successful Payjoin. TXID: f4715d46490928f7a458077782c845d8a28989c71cf891fc28d2c9fe492549c6
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] advancing offset within the current segment from 1065 to 1083
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] wrote lsns 1065-1082 to disk at offsets 1065-1082, maxed false complete_len 18
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] mark_interval(1065, 18)
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] new highest interval: 1065 - 1082
[2025-03-05T04:21:16Z DEBUG sled::pagecache::iobuf] make_stable(1082) returning
[2025-03-05T04:21:16Z DEBUG sled::pagecache::logger] IoBufs dropped
```

Because we're using regtest, we'll need to mine a block to see the transaction update the wallet balances.
```bash
bitcoin-cli -regtest generatetoaddress 1 $ocean_address
bitcoin-cli -regtest -rpcwallet=ocean getbalance
> 149.99989791
bitcoin-cli -regtest -rpcwallet=boom getbalance
> 5050.00010000
```

I've payjoined!

Next up is to run the full stack locally to get a better handle on the operation of the relay/directory server.

## PR reviews
Checkout relevant forks & branches to build and test PRs locally where necessary:
- https://github.com/benalleng/rust-payjoin
- https://github.com/IgnacioPorte/rust-payjoin

### \#529 - Refactor replacement outputs to be an iterator of ref TxOuts
https://github.com/payjoin/rust-payjoin/pull/529/files

Reviewers also referenced an earlier PR: https://github.com/payjoin/rust-payjoin/pull/527

I tend to agree with the reviewer comments that there is little to gain from turning a vector into an iterator and using explicit reference lifetime specification - converting back to a vector internally: `let mut replacement_outputs_vec: Vec<TxOut> = replacement_outputs.cloned().collect();`

Changing `WantsOutputs` to `Self` in `replace_receiver_outputs` and `substitute_receiver_script` is probably fine, both are `pub fn` on `WantsOutputs`.

The following comment provides additional insight into the original motivation of the change:
> The reason to do it here is different than just changing ownership to a ref. Perhaps the iterator is a db struct and not an in-memory Vec, which is where a more generic interface is helpful. I did some LLMing to get interleave_shuffle to also take an interator which is I think what needs to happen to realize the generalization here.

So it seems that the PR needs work to realise this goal without falling back to a vector as an intermediate data structure.

### \#554 - Add additional tests for v2 send module
https://github.com/payjoin/rust-payjoin/pull/554

Both this PR and the following \#556 are motivated by the results of preliminary mutation testing (aside: ["Mutation testing assesses test suite efficacy by inserting small faults into programs and measuring the ability of the test suite to detect them"](https://storage.googleapis.com/gweb-research2023-media/pubtools/4203.pdf)). This PR introduces new tests for both the send and receive modules for v2 payjoins. New tests:
- `create_sender_context`
- `test_serialize_v2`
- `test_extract_v2_success`
- `test_extract_v2_fails_missing_pubkey`
- `test_extract_v2_fails_missing_ohttp_config`
- `test_extract_v2_fails_when_expired`

It also refactors some of the testing `const`s and a URLs out of `payjoin/src/receive/v2/mod.rs` and into `payjoin-test-utils/src/lib.rs`.

There were a few minor issues with the PR, I identified and commented on one (https://github.com/payjoin/rust-payjoin/pull/554#discussion_r1979701544), but overall the PR is a good change in improving test coverage.

### \#556 - Add additional tests for v1 send module
https://github.com/payjoin/rust-payjoin/pull/556

This builds upon some of the work done in \#554, with a focus on the v1 module. It is mainly relating to the v1 send module, with new tests:
- `test_determine_fees`
- `test_self_pay_change_index`
- `test_find_change_index`
- `test_single_payee_amount_mismatch`
- `test_clear_unneeded_fields`
- `test_build_recommended`

By the time I reviewed the PR, the PR looked good. Additional testing `const`s moved to `payjoin-test-utils/src/lib.rs` and associated tidy-up, new tests as above improving test coverage.

### \#557 - Add consolidation input selection strategy
https://github.com/payjoin/rust-payjoin/pull/557

This PR introduces a new strategy for the receiver to select which inputs they contribute to the payjoin.
The strategy is "select for consolidation" - the receiver is supposed to supply some candidate inputs.
Of the candidate inputs, the largest is selected:

```Rust
// Sort candidates by value and select largest one
let mut candidates: Vec<InputPair> = candidate_inputs.into_iter().collect();
if candidates.is_empty() {
    return Err(InternalSelectionError::Empty.into());
}

candidates.sort_by_key(|input| input.previous_txout().value);
Ok(candidates.pop().unwrap())
```

On having a bit more of a dig around surrounding code, I wonder if there's more nuance to this input selection strategy.
Especially relating to avoiding heuristics that are used in blockchain analysis (the example is "Unnecessary Input Heuristic").
I left a comment asking the question: https://github.com/payjoin/rust-payjoin/pull/557/files#r1981698554.

Being a draft PR there's obviously more work to be done, such as addressing questions like the above and other reviewer comments.
But after this, once the concept is ACKed, things like the following will also likely need to follow:
- the selection of input selection strategy is configurable, or an order or precedence of selection strategy can be specified
- automatic selection of inputs from receivers wallet?

## Personal thoughts
Although I previously thought that the concept of payjoin was sound in breaking analysis techniques and heuristics, I thought that (without really knowing TBH) that there must be some significant challenge to implementation because it wasn't really available as an option to users.

After putting this material together I now understand the historical state-of-play and why it indeed hasn't
really been an option until now. It seems that the async and enhanced client privacy approach of BIP 77 `v2` payjoin, which is leveraging some fairly new tech in HPKE and OHTTP (if the IETF doc dates are anything to go by), may be the right technical pieces to change this. And of course, there is now a concerted effort with the Payjoin Dev Kit and rust-payjoin to build this out and make this happen. 
